name: Update send-to-stata

on:
  schedule:
    - cron: '0 0 1 * *'  # Monthly on the 1st
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for updates
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest release from send-to-stata repo
          LATEST=$(gh api repos/jbearak/send-to-stata/releases/latest --jq '.tag_name' 2>/dev/null || echo "")
          if [ -z "$LATEST" ]; then
            echo "No releases found"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"
          
          # Get current checksum
          CURRENT_X64=""
          if [ -f send-to-stata-x64.exe.sha256 ]; then
            CURRENT_X64=$(cat send-to-stata-x64.exe.sha256 | tr -d '[:space:]')
          elif [ -f send-to-stata-x64.exe ]; then
            CURRENT_X64=$(sha256sum send-to-stata-x64.exe | cut -d' ' -f1)
          fi
          
          # Get new checksum from release
          NEW_X64=$(gh api repos/jbearak/send-to-stata/releases/latest --jq '.assets[] | select(.name=="send-to-stata-x64.exe.sha256") | .browser_download_url' | xargs curl -sL | tr -d '[:space:]')
          
          if [ "$CURRENT_X64" = "$NEW_X64" ]; then
            echo "Already up to date"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # Check if PR already exists
          EXISTING=$(gh pr list --search "Update send-to-stata to $LATEST" --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING" ]; then
            echo "PR #$EXISTING already exists"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "needs_update=true" >> "$GITHUB_OUTPUT"

      - name: Download new binaries
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST="${{ steps.check.outputs.latest }}"
          gh release download "$LATEST" --repo jbearak/send-to-stata --pattern "send-to-stata-*.exe" --clobber
          gh release download "$LATEST" --repo jbearak/send-to-stata --pattern "send-to-stata-*.sha256" --clobber

      - name: Create PR
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST="${{ steps.check.outputs.latest }}"
          BRANCH="update-send-to-stata-$LATEST"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH"
          git add send-to-stata-*.exe send-to-stata-*.sha256
          git commit -m "Update send-to-stata to $LATEST"
          git push origin "$BRANCH"
          
          gh pr create \
            --title "Update send-to-stata to $LATEST" \
            --body "Updates send-to-stata binaries to $LATEST from [jbearak/send-to-stata](https://github.com/jbearak/send-to-stata/releases/tag/$LATEST)."
