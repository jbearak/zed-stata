name: Update send-to-stata

on:
  schedule:
    - cron: '0 0 1 * *'  # Monthly on the 1st
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for updates
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest release from send-to-stata repo
          LATEST=$(gh api repos/jbearak/send-to-stata/releases/latest --jq '.tag_name' 2>/dev/null || echo "")
          if [ -z "$LATEST" ]; then
            echo "No releases found"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"
          
          # Get current checksum from installer script
          CURRENT_X64=$(grep '^\$expectedChecksumX64 = ' install-send-to-stata.ps1 | sed 's/.*"\(.*\)".*/\1/')
          
          # Get new checksum from release
          NEW_X64_URL=$(gh api repos/jbearak/send-to-stata/releases/latest --jq '.assets[] | select(.name=="send-to-stata-x64.exe.sha256") | .browser_download_url')
          NEW_X64=$(wget -qO- "$NEW_X64_URL" | tr -d '[:space:]')
          
          echo "Current X64 checksum: $CURRENT_X64"
          echo "Latest X64 checksum: $NEW_X64"
          
          if [ "$CURRENT_X64" = "$NEW_X64" ]; then
            echo "Already up to date"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # Check if PR already exists
          EXISTING=$(gh pr list --search "Update send-to-stata to $LATEST" --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING" ]; then
            echo "PR #$EXISTING already exists"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "needs_update=true" >> "$GITHUB_OUTPUT"

      - name: Update checksums
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST="${{ steps.check.outputs.latest }}"
          
          # Download checksums from release
          ARM64_URL=$(gh api repos/jbearak/send-to-stata/releases/latest --jq '.assets[] | select(.name=="send-to-stata-arm64.exe.sha256") | .browser_download_url')
          X64_URL=$(gh api repos/jbearak/send-to-stata/releases/latest --jq '.assets[] | select(.name=="send-to-stata-x64.exe.sha256") | .browser_download_url')
          
          ARM64_SHA=$(wget -qO- "$ARM64_URL" | tr -d '[:space:]')
          X64_SHA=$(wget -qO- "$X64_URL" | tr -d '[:space:]')
          
          echo "ARM64 checksum: $ARM64_SHA"
          echo "X64 checksum: $X64_SHA"
          
          # Update checksums in installer
          sed -i "s/^\$expectedChecksumArm64 = \".*\"/\$expectedChecksumArm64 = \"$ARM64_SHA\"/" install-send-to-stata.ps1
          sed -i "s/^\$expectedChecksumX64 = \".*\"/\$expectedChecksumX64 = \"$X64_SHA\"/" install-send-to-stata.ps1
          
          # Verify changes
          git diff install-send-to-stata.ps1

      - name: Create PR
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST="${{ steps.check.outputs.latest }}"
          BRANCH="update-send-to-stata-$LATEST"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git push origin --delete "$BRANCH" 2>/dev/null || true
          git checkout -b "$BRANCH"
          git add install-send-to-stata.ps1
          git commit -m "Update send-to-stata checksums to $LATEST"
          git push origin "$BRANCH"
          
          gh pr create \
            --title "Update send-to-stata to $LATEST" \
            --body "Updates send-to-stata checksums to $LATEST from [jbearak/send-to-stata](https://github.com/jbearak/send-to-stata/releases/tag/$LATEST)."
